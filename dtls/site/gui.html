<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Peerster</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="sb-admin-2.css" type="text/css">
    <link href="font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="morris.css" rel="stylesheet">
    <link href="metisMenu.min.css" rel="stylesheet">
    <script>
        $(document).ready(function(){
            var debug = true;

            $.getJSON("http://" + location.hostname+":"+location.port + "/id", function (data) {
                $("#id-box").text(data)
            });

            var private_peer = "";

            var stringToColour = function(str) {
                var hash = 0;
                for (var i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                var colour = '';
                for (var j = 0; j < 3; j++) {
                    var value = (hash >> (j * 8)) & 0xFF;
                    colour += ('00' + value.toString(16)).substr(-2);
                }
                return colour;
            };

            var msgFromMe = function(message){
                return                     "<li class=\"right clearfix\">" +
                    "<span class=\"chat-img pull-right\">" +
                    "<img src='http://placehold.it/50/" + stringToColour(message["Origin"]) + "/fff' alt=\"User Avatar\" class=\"img-circle\">" +
                    "</span>" +
                    "<div class=\"chat-body clearfix\">" +
                    "<div class=\"header\">" +
                    "<small class=\" text-muted\">" +
                    "<i class=\"fa fa-clock-o fa-fw\"></i> 13 mins ago</small>" +
                    "<strong class=\"pull-right primary-font\">Me</strong>" +
                    "</div>" +
                    "<p>" +
                    message["Text"] +
                    "</p>" +
                    "</div>" +
                    "</li>"
            };
            var msgToMe = function(message){
                return "<li class=\"left clearfix\">" +
                    "<span class=\"chat-img pull-left\">" +
                    "<img src='http://placehold.it/50/" + stringToColour(message["Origin"]) + "/fff' alt=\"User Avatar\" class=\"img-circle\">" +
                    "</span>" +
                    "<div class=\"chat-body clearfix\">" +
                    "<div class=\"header\">" +
                    "<strong class=\"primary-font\">" + message["Origin"] + "</strong>" +
                    "<small class=\"pull-right text-muted\">" +
                    "<i class=\"fa fa-clock-o fa-fw\"></i> 12 mins ago" +
                    "</small>" +
                    "</div>" +
                    "<p>" +
                        message["Text"] +
                    "</p>" +
                    "</div>" +
                    "</li>"
            };

            // Handle request to change id
            $("#btn-change-id").click(function(){
                var new_id = $("#change-id-input").val()
                $.post("http://" + location.hostname+":"+location.port + "/id/" + new_id);
            });

            // Handle sending message to global chat
            $("#btn-global-chat").click(function(){
                var message = {};
                message["Origin"] = $("#id-box").text();
                message["Text"] = $("#global-chat-input").val();
                $.post("http://" + location.hostname+":"+location.port + "/message", {
                    "text":message["Text"]
                });
                if (debug) {console.log(message)}
                $("#global-chat").prepend(
                    msgFromMe(message)
                );
            });

            // Handle request to add to known nodes
            $("#btn-known-nodes").click(function () {
                var address = $("#known-nodes-input").val();
                $.post("http://" + location.hostname+":"+location.port + "/node", {
                    "address": address
                });
            });

            // Handle sending message to private chat
            $("#btn-private-chat").click(function(){
                var message = {};
                message["Origin"] = $("#id-box").text();
                message["Text"] = $("#private-chat-input").val();
                $.post("http://" + location.hostname+":"+location.port + "/message/" + private_peer, {
                    "text":message["Text"]
                });
                $("#private-chat").prepend(msgFromMe(message));
            });

            $("#btn-file-upload").click(function () {
                var file_list = $("#file-upload-input")[0].files;
                if (file_list.length > 0) {
                    var file_name = file_list[0]["name"];
                    $.post("http://" + location.hostname+":"+location.port + "/file/upload", {
                        "file_name": file_name
                    });
                }
            });

            $("#btn-file-download").click(function () {
                var dest = $("#file-download-dest-input").val();
                var file_name = $("#file-download-file-name-input").val();
                var hex_hash = $("#file-download-hex-hash-input").val();
                $.post("http://" + location.hostname+":"+location.port + "/file/download", {
                    "dest": dest,
                    "file_name": file_name,
                    "hex_hash": hex_hash
                });
            });
            
            $("#btn-file-search").click(function () {
                var keywords = $("#file-search-input").val();
                $.post("http://" + location.hostname+":"+location.port + "/file/search", { "keywords":keywords });
            });

            // Periodically, retrieve state from server
            setInterval(function(){
                $.getJSON("http://" + location.hostname+":"+location.port + "/id", function (data) {
                    $("#id-box").text(data)
                });

                $.getJSON("http://" + location.hostname+":"+location.port + "/file/search", function(data) {
                    $("#remote-files-list").empty();
                    if (debug) {console.log(data)}
                    if (data != null) {
                        for (var fh in data) {
                            console.log(data[fh])
                            parts = data[fh].split(":")
                            file_name = parts[0]
                            hash = parts[1]
                            $("#remote-files-list").append("<li><button id=\"" + hash + "\" class='download-file'>" +
                                file_name + "</button></li>");
                        }

                        $(".download-file").click(function () {
                            file_name = $(this).text()
                            metahash = $(this).attr('id');
                            if (debug) {console.log("Downloading " + file_name + " with metahash: " + metahash)}
                            $.post("http://" + location.hostname+":"+location.port + "/file/download", {
                                "file_name": file_name,
                                "hex_hash": metahash
                            })
                        });
                    }
                });

                $.getJSON("http://" + location.hostname+":"+location.port + "/file/list/local", function (data) {
                    $("#local-files-list").empty()
                    if (debug) {console.log(data)}
                    if (data != null) {
                        for (var key in data) {
                            $("#local-files-list").append("<li>" + key + " (" + data[key] + ")</li>");
                            $(".open-private-chat").click(function() {
                                private_peer = $(this).attr('id');
                                console.log("PM with: " + private_peer)
                                $("#private-chat").empty()
                                $("#private-chat-header").text("Private chat with " + private_peer)
                            });
                        }
                    }
                });

                var num_msgs = $("#global-chat").children().length
                $.getJSON("http://" + location.hostname+":"+location.port + "/message/" + num_msgs, function (data) {
                    if (data != null && data.length != 0) {
                        for (i = 0; i < data.length; i++) {
                            var name = $("#id-box").text();
                            var message = data[i]["Rumor"];
                            if (debug) {console.log(message)}
                            if (message["Origin"] == name) {
                                $("#global-chat").prepend(msgFromMe(message))
                            } else {
                                $("#global-chat").prepend(msgToMe(message))
                            }
                        }
                    }
                });
                $.getJSON("http://" + location.hostname+":"+location.port + "/node", function (data) {
                    $("#nodes-list").empty();
                    if (data != null && data.length != 0) {
                        for (i = 0; i < data.length; i++) {
                            $("#nodes-list").append("<p>" + data[i] + "</p>")
                        }
                    }
                });
                $.getJSON("http://" + location.hostname+":"+location.port + "/peers", function (data) {
                    $("#peers-list").empty();
                    if (debug) {console.log(data)}
                    if (data != null) {
                        for (var key in data) {
                            $("#peers-list").append("<li><button id=\"" + key +"\" class='open-private-chat'>" +
                                key + " (" + data[key]["Next"] + ")" +
                                "</button></li>");
                        }
                        $(".open-private-chat").click(function() {
                            private_peer = $(this).attr('id');
                            console.log("PM with: " + private_peer)
                            $("#private-chat").empty()
                            $("#private-chat-header").text("Private chat with " + private_peer)
                        });
                    }
                });

                if (private_peer != "") {
                    var num_private_msgs = $("#private-chat").children().length
                    $.getJSON("http://" + location.hostname + ":" + location.port + "/message/" + private_peer + "/" + num_private_msgs, function (data) {
                        if (data != null && data.length != 0) {
                            for (i = 0; i < data.length; i++) {
                                if (data[i] == null) {
                                    continue
                                }
                                var name = $("#id-box").text();
                                var message = data[i]["Private"];
                                if (debug) {
                                    console.log(data[i], message)
                                }
                                if (message["Origin"] == name) {
                                    $("#private-chat").prepend(msgFromMe(message))
                                } else {
                                    $("#private-chat").prepend(msgToMe(message))
                                }
                            }
                        }
                    });
                }
            }, 3000)
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="navbar">
                <div id="id-box"><p>Identifier</p></div>
                <div class="input-group">
                    <input id="change-id-input" type="text" class="form-control input-sm" placeholder="New id...">
                    <span class="input-group-btn">
                        <button class="btn btn-warning btn-sm" id="btn-change-id">
                            Change Id
                        </button>
                    </span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-5">
                <div class="row">
                    <div class="chat-panel panel panel-info panel-default">
                        <div class="panel-heading">
                            <p>Global Chat</p>
                        </div>

                        <div class="panel-body">
                            <ul id="global-chat" class="chat"></ul>
                        </div>

                        <div class="panel-footer">
                            <div class="input-group">
                                <input id="global-chat-input" type="text" class="form-control input-sm" placeholder="Type your message here...">
                                <span class="input-group-btn">
                                        <button class="btn btn-warning btn-sm" id="btn-global-chat">
                                            Send
                                        </button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <row>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Peers
                        </div>

                        <div class="panel-body">
                            <ul id="peers-list"></ul>
                        </div>
                    </div>
                </row>

                <row>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Known Nodes
                        </div>

                        <div class="panel-body">
                            <ul id="nodes-list"></ul>
                        </div>

                        <div class="panel-footer">
                            <div class="input-group">
                                <input id="known-nodes-input" type="text" class="form-control input-sm" placeholder="Node address...">
                                <span class="input-group-btn">
                                    <button class="btn btn-warning btn-sm" id="btn-known-nodes">
                                        Add
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                </row>
            </div>

            <div class="col-lg-4">
                <div class="chat-panel panel panel-info">
                    <div class="panel-heading">
                        <p id="private-chat-header">Private Chat</p>
                    </div>

                    <div class="panel-body">
                        <ul id="private-chat" class="chat"></ul>
                    </div>

                    <div class="panel-footer">
                        <div class="input-group">
                            <input id="private-chat-input" type="text" class="form-control input-sm" placeholder="Type your message here...">
                            <span class="input-group-btn">
                                    <button class="btn btn-warning btn-sm" id="btn-private-chat">
                                        Send
                                    </button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4">
                <div class="panel panel-success">
                    <div class="panel-heading">
                        My Files
                    </div>
                    <div class="panel-body">
                        <div style="word-wrap:break-word;">
                            <ul id="local-files-list"></ul>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <input id="file-upload-input" type="file">
                        <span class="input-group-btn">
                            <button class="btn btn-warning btn-sm" id="btn-file-upload">
                                Upload File
                            </button>
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="panel panel-warning">
                    <div class="panel-heading">
                        File Search
                        <div class="input-group">
                            <input id="file-search-input" type="text" class="form-control input-sm" placeholder="Keywords (file,ex,...)">
                            <span class="input-group-btn">
                                    <button class="btn btn-warning btn-sm" id="btn-file-search">
                                        Search
                                    </button>
                            </span>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div style="word-wrap:break-word;">
                            <ul id="remote-files-list"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="panel panel-danger">
                    <div class="panel-heading">
                        Download File
                    </div>
                    <div class="panel-body">
                        <input id="file-download-dest-input" type="text" class="form-control input-sm" placeholder="Destination peer...">
                        <input id="file-download-file-name-input" type="text" class="form-control input-sm" placeholder="File name...">
                        <input id="file-download-hex-hash-input" type="text" class="form-control input-sm" placeholder="Hex of file metahash...">
                    </div>
                    <div class="panel-footer">
                            <span class="input-group-btn">
                                <button class="btn btn-warning btn-sm" id="btn-file-download">
                                    Download File
                                </button>
                            </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>